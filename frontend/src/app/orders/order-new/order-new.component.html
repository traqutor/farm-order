<div class="padding-content"
     fxFlex
     fxLayout="column"
>
  <div
    fxLayout="row"
  >
    <div>
      <h2 class="mat-title">New Order</h2>
      <p class="mat-subheading-2">Define new order.</p>
    </div>
  </div>

  <mat-divider></mat-divider>

  <div *ngIf="order" class="padding-content">
    <form [formGroup]="order" fxLayout="column" class="half-width"
          [ngClass.xs]="{'half-width':false, 'full-width':true}">

      <mat-form-field>
        <input matInput
               type="number"
               placeholder="Tons ordered"
               formControlName="tonsOrdered"
               (change)="getTotalOrderAmount()"
        >
        <mat-error
          *ngIf="order.get('tonsOrdered').hasError('required') && order.get('tonsOrdered').touched">
          Tons ordered is required.
        </mat-error>
        <mat-error
          *ngIf="order.get('tonsOrdered').hasError('min') && order.get('tonsOrdered').touched">
          Minimum tons ordered is 1.
        </mat-error>
      </mat-form-field>

      <!--farms-->
      <mat-form-field>
        <mat-select #option placeholder="Select Farm" formControlName="farm"
                    (valueChange)="getRations(option.value); getSheds(option.value)">
          <mat-option *ngFor="let farm of farms" [value]="farm">
            {{farm.name}}
          </mat-option>
        </mat-select>
        <mat-error
          *ngIf="order.get('farm').hasError('required') && order.get('farm').touched">
          Farm is required.
        </mat-error>
      </mat-form-field>

      <!--ration-->
      <mat-form-field *ngIf="this.order.value.farm !== null && (rations$ | async) as rations">
        <mat-select placeholder="Select Ration" formControlName="ration">
          <mat-option *ngFor="let ration of rations.results" [value]="ration">
            {{ration.name}}
          </mat-option>
        </mat-select>
        <mat-error
          *ngIf="order.get('ration').hasError('required') && order.get('ration').touched">
          Ration is required.
        </mat-error>
      </mat-form-field>

      <!--sheds-->
      <mat-form-field *ngIf="this.order.value.farm !== null && (sheds$ | async) as sheds">
        <mat-select #selectedSheds placeholder="Select Sheds"
                    (valueChange)="getSilos(selectedSheds.value)"
                    formControlName="sheds"
                    multiple>
          <mat-option *ngFor="let shed of sheds.results" [value]="shed">
            {{shed.name}}
          </mat-option>
        </mat-select>
        <mat-error
          *ngIf="order.get('sheds').hasError('required') && order.get('sheds').touched">
          Sheds are required.
        </mat-error>
      </mat-form-field>

      <!--silos-->
      <mat-form-field
        *ngIf="this.order.value.farm !== null && this.order.value.sheds !== null && (silos$ | async) as silos">
        <mat-select placeholder="Select Silos" formControlName="silos" multiple>
          <mat-option *ngFor="let silo of silos.results" [value]="silo">
            {{silo.name}}
          </mat-option>
        </mat-select>
        <mat-error
          *ngIf="order.get('silos').hasError('required') && order.get('silos').touched">
          Silos are required.
        </mat-error>
      </mat-form-field>

      <div>
        <div *ngFor="let silo of order.controls.silos.value" fxLayout="row">
          <div>{{silo.name}}: <button mat-button color="primary" [matMenuTriggerFor]="menu">
            <mat-icon>arrow_drop_down</mat-icon>
            {{silo.amount}}
          </button>
            <mat-menu #menu="matMenu" >
              <button mat-menu-item *ngFor="let i of [2, 5, 10, 15, 20, 25, 30]"
                      (click)="silo.amount = i; recalculateOrderTonnage()"
              >{{i}} tons</button>
            </mat-menu> tons of total silo capacity: {{silo.capacity}} </div>
        </div>
      </div>

      <div>
        <p>Total ordered vs. Silos distributed tonnage: <b>{{orderTotalTonnage}}</b> / <b>{{orderSilosTonnage}}</b>
        </p>
      </div>


      <!--order date-->
      <mat-form-field>
        <input matInput [matDatepicker]="dp3" placeholder="Delivery Date" formControlName="deliveryDate">
        <mat-datepicker-toggle matSuffix [for]="dp3"></mat-datepicker-toggle>
        <mat-datepicker #dp3 disabled="false"></mat-datepicker>
      </mat-form-field>

      <div fxLayout="row">

        <button
          mat-raised-button
          (click)="onSubmit()"
          color="primary"
          [disabled]="order.invalid"
        >
          Add Order
        </button>

        <button mat-button (click)="cancel()" >
          Cancel
        </button>

      </div>
    </form>
  </div>

</div>
