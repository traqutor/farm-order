<div class="padding-content"
     fxFlex
     fxLayout="column"
>
  <div
    fxLayout="row"
  >
    <div>
      <h2 class="mat-title">Order</h2>
      <p class="mat-subheading-2">Edit the order definition and select the change reason.</p>
    </div>
  </div>


  <div class="padding-content" *ngIf="order">

    <form [formGroup]="order" fxLayout="column" class="half-width">

      <!--tons-->
      <mat-form-field appearance="outline">

        <mat-label>Tons</mat-label>

        <input matInput
               type="number"
               placeholder="Tons ordered"
               formControlName="tonsOrdered"
               (change)="getTotalOrderAmount()">
        <mat-error
          *ngIf="order.get('tonsOrdered').hasError('required') && order.get('tonsOrdered').touched">
          Tons ordered is required.
        </mat-error>
        <mat-error
          *ngIf="order.get('tonsOrdered').hasError('min') && order.get('tonsOrdered').touched">
          Minimum tons ordered is 1.
        </mat-error>
      </mat-form-field>

      <!--farm-->
      <mat-form-field appearance="outline" *ngIf="farms">

        <mat-label>Farm</mat-label>

        <mat-select #option placeholder="Select Farm"
                    formControlName="farm"
                    [compareWith]="compare"
                    (valueChange)="getRations(option.value); getSheds(option.value)">
          <mat-option *ngFor="let farm of farms.results" [value]="farm">
            {{farm.name}}
          </mat-option>
        </mat-select>

        <mat-error
          *ngIf="order.get('farm').hasError('required') && order.get('farm').touched">
          Farm is required.
        </mat-error>

      </mat-form-field>

      <!--rations-->
      <mat-form-field appearance="outline"
                      *ngIf="this.order.value.farm !== null && (rations$ | async) as rations">

        <mat-label>Ration</mat-label>

        <mat-select placeholder="Select Ration"
                    formControlName="ration"
                    [compareWith]="compare">
          <mat-option *ngFor="let ration of rations.results" [value]="ration">
            {{ration.name}}
          </mat-option>
        </mat-select>

        <mat-error
          *ngIf="order.get('ration').hasError('required') && order.get('ration').touched">
          Ration is required.
        </mat-error>
      </mat-form-field>

      <!--status-->
      <mat-form-field appearance="outline"
                      *ngIf="(status$ | async) as status">

        <mat-label>Status</mat-label>

        <mat-select placeholder="Select Status"
                    formControlName="status"
                    [compareWith]="compare">
          <mat-option *ngFor="let status of status.results" [value]="status">
            {{status.name}}
          </mat-option>
        </mat-select>

        <mat-error
          *ngIf="order.get('farm').hasError('required') && order.get('farm').touched">
          Farm is required.
        </mat-error>

      </mat-form-field>

      <!--sheds-->
      <mat-form-field appearance="outline"
                      *ngIf="this.order.value.farm !== null && (sheds$ | async) as sheds">

        <mat-label>Sheds</mat-label>

        <mat-select #selectedSheds placeholder="Select Sheds"
                    (valueChange)="getSilos(selectedSheds.value)"
                    formControlName="sheds"
                    [compareWith]="compare"
                    multiple>
          <mat-option *ngFor="let shed of sheds.results" [value]="shed">
            {{shed.name}}
          </mat-option>
        </mat-select>
        <mat-error
          *ngIf="order.get('sheds').hasError('required') && order.get('sheds').touched">
          Sheds are required.
        </mat-error>
      </mat-form-field>

      <!--silos-->
      <mat-form-field appearance="outline"
        *ngIf="this.order.value.farm !== null && this.order.value.sheds !== null && (silos$ | async) as silosSet">

        <mat-label>Silos</mat-label>

        <mat-select placeholder="Select Silos"
                    formControlName="silos"
                    (valueChange)="onSiloSelectChange()"
                    [compareWith]="compare"
                    multiple
        >
          <mat-option *ngFor="let silo of silosSet.results" [value]="silo">
            {{silo.name}}
          </mat-option>
        </mat-select>

        <mat-error
          *ngIf="order.get('silos').hasError('required') && order.get('silos').touched">
          Silos are required.
        </mat-error>
      </mat-form-field>

      <div *ngFor="let silo of order.controls.silos.value"
           [style.color]="silo.amount>silo.capacity ? 'red': ''"
           fxLayout="row"
           fxLayoutAlign="start center"
      >
        <span>{{silo.name}}:</span>

        <mat-form-field appearance="outline" class="silo-amount-input">
          <mat-label>Amount</mat-label>

          <input type="number"
                 matInput
                 maxlength="2"
                 min="0"
                 max="50"
                 [(ngModel)]="silo.amount"
                 [ngModelOptions]="{standalone: true}"
                 (ngModelChange)="onSiloAmountChange(silo)">
        </mat-form-field>

        <span>(MAX <b>{{silo.capacity}}</b> tons)</span>
      </div>

      <div>
        <p>Allocated / Total ordered tonnage:
          <button mat-button
                  [color]="orderTotalTonnage<orderSilosTonnage? 'warn': 'primary'"
          > {{orderSilosTonnage}} / {{orderTotalTonnage}}
          </button>
        </p>
      </div>


      <!--reason change-->
      <mat-form-field appearance="outline" *ngIf="(orderChangeReason$ | async) as orderChangeReasons">
        <mat-label>Order change reason</mat-label>
        <mat-select placeholder="Select order change reason"
                    formControlName="orderChangeReason"
                    [compareWith]="compare">
          <mat-option *ngFor="let orderChangeReason of orderChangeReasons.results" [value]="orderChangeReason">
            {{orderChangeReason.name}}
          </mat-option>
        </mat-select>
        <mat-error
          *ngIf="order.get('farm').hasError('required') && order.get('farm').touched">
          Farm is required.
        </mat-error>
      </mat-form-field>

      <!--devivery date-->
      <mat-form-field appearance="outline">
        <mat-label>Delivery Date</mat-label>
        <input matInput [matDatepicker]="dp3"  formControlName="deliveryDate">
        <mat-datepicker-toggle matSuffix [for]="dp3"></mat-datepicker-toggle>
        <mat-datepicker #dp3 disabled="false"></mat-datepicker>
      </mat-form-field>

      <div fxLayout="row" class="button-row">

        <button
          mat-raised-button
          color="accent"
          (click)="onSubmit()"
          [disabled]="order.invalid || orderTotalTonnage<orderSilosTonnage"
        >
          Save Order
        </button>

        <button mat-raised-button (click)="cancel()">
          Cancel
        </button>

      </div>
    </form>
  </div>

</div>
